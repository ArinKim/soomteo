<!--&lt;!&ndash;<!DOCTYPE html>&ndash;&gt;-->
<!--&lt;!&ndash;<html lang="ko">&ndash;&gt;-->
<!--&lt;!&ndash;<head>&ndash;&gt;-->
<!--&lt;!&ndash;    <meta charset="UTF-8" />&ndash;&gt;-->
<!--&lt;!&ndash;    <title>WebSocket Chat Test</title>&ndash;&gt;-->

<!--&lt;!&ndash;    &lt;!&ndash; ★ SockJS / STOMP 라이브러리: 반드시 우리 코드보다 위에 있어야 함 &ndash;&gt;&ndash;&gt;-->
<!--&lt;!&ndash;    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>&ndash;&gt;-->
<!--&lt;!&ndash;    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>&ndash;&gt;-->
<!--&lt;!&ndash;</head>&ndash;&gt;-->
<!--&lt;!&ndash;<body>&ndash;&gt;-->
<!--&lt;!&ndash;<h2>WebSocket Chat Test (roomId = test)</h2>&ndash;&gt;-->

<!--&lt;!&ndash;<div>&ndash;&gt;-->
<!--&lt;!&ndash;    <input id="messageInput" placeholder="메시지를 입력하세요" />&ndash;&gt;-->
<!--&lt;!&ndash;    <button onclick="sendMessage()">전송</button>&ndash;&gt;-->
<!--&lt;!&ndash;</div>&ndash;&gt;-->

<!--&lt;!&ndash;<p>상태: <span id="status">연결 안 됨</span></p>&ndash;&gt;-->

<!--&lt;!&ndash;&lt;!&ndash; ★ 여기 id="log" 가 꼭 있어야 log() 함수가 동작함 &ndash;&gt;&ndash;&gt;-->
<!--&lt;!&ndash;<ul id="log"></ul>&ndash;&gt;-->

<!--&lt;!&ndash;&lt;!&ndash; 우리 스크립트는 body 맨 마지막에 &ndash;&gt;&ndash;&gt;-->
<!--&lt;!&ndash;<script>&ndash;&gt;-->
<!--&lt;!&ndash;    let stompClient = null;&ndash;&gt;-->
<!--&lt;!&ndash;    let roomId = "A"; // 방 아이디 고정&ndash;&gt;-->

<!--&lt;!&ndash;    // ✅ 사용자 이름(닉네임) 저장할 변수&ndash;&gt;-->
<!--&lt;!&ndash;    let userName = "나";&ndash;&gt;-->


<!--&lt;!&ndash;    function log(text) {&ndash;&gt;-->
<!--&lt;!&ndash;        const ul = document.getElementById("log");&ndash;&gt;-->
<!--&lt;!&ndash;        if (!ul) {&ndash;&gt;-->
<!--&lt;!&ndash;            console.error("log element not found");&ndash;&gt;-->
<!--&lt;!&ndash;            return;&ndash;&gt;-->
<!--&lt;!&ndash;        }&ndash;&gt;-->
<!--&lt;!&ndash;        const li = document.createElement("li");&ndash;&gt;-->
<!--&lt;!&ndash;        li.innerText = text;&ndash;&gt;-->
<!--&lt;!&ndash;        ul.appendChild(li);&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->

<!--&lt;!&ndash;    // 서버에 저장된 이전 대화 불러오기&ndash;&gt;-->
<!--&lt;!&ndash;    async function loadHistory() {&ndash;&gt;-->
<!--&lt;!&ndash;        try {&ndash;&gt;-->
<!--&lt;!&ndash;            const res = await fetch(`/api/chat/${roomId}/messages`);&ndash;&gt;-->
<!--&lt;!&ndash;            const history = await res.json(); // ["{\"roomId\":\"test\",...}", ...]&ndash;&gt;-->
<!--&lt;!&ndash;            history.forEach(str => {&ndash;&gt;-->
<!--&lt;!&ndash;                try {&ndash;&gt;-->
<!--&lt;!&ndash;                    const msg = JSON.parse(str);&ndash;&gt;-->
<!--&lt;!&ndash;                    log(`[이전] ${msg.senderName} : ${msg.content}`);&ndash;&gt;-->
<!--&lt;!&ndash;                } catch (e) {&ndash;&gt;-->
<!--&lt;!&ndash;                    console.error("parse error", e);&ndash;&gt;-->
<!--&lt;!&ndash;                }&ndash;&gt;-->
<!--&lt;!&ndash;            });&ndash;&gt;-->
<!--&lt;!&ndash;        } catch (e) {&ndash;&gt;-->
<!--&lt;!&ndash;            console.error("load history error", e);&ndash;&gt;-->
<!--&lt;!&ndash;        }&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->

<!--&lt;!&ndash;    function connect() {&ndash;&gt;-->
<!--&lt;!&ndash;        // ★ SockJS가 위에서 로드되어 있어야 여기서 사용 가능&ndash;&gt;-->
<!--&lt;!&ndash;        const socket = new SockJS("/ws");&ndash;&gt;-->
<!--&lt;!&ndash;        stompClient = Stomp.over(socket);&ndash;&gt;-->

<!--&lt;!&ndash;        stompClient.connect(&ndash;&gt;-->
<!--&lt;!&ndash;            {},&ndash;&gt;-->
<!--&lt;!&ndash;            frame => {&ndash;&gt;-->
<!--&lt;!&ndash;                document.getElementById("status").innerText = "연결됨 ✅";&ndash;&gt;-->
<!--&lt;!&ndash;                console.log("STOMP connected: ", frame);&ndash;&gt;-->

<!--&lt;!&ndash;                // /sub/chat/test 구독&ndash;&gt;-->
<!--&lt;!&ndash;                stompClient.subscribe(`/sub/chat/${roomId}`, message => {&ndash;&gt;-->
<!--&lt;!&ndash;                    const body = JSON.parse(message.body);&ndash;&gt;-->
<!--&lt;!&ndash;                    log(`[수신] ${body.senderName} : ${body.content}`);&ndash;&gt;-->
<!--&lt;!&ndash;                });&ndash;&gt;-->
<!--&lt;!&ndash;            },&ndash;&gt;-->
<!--&lt;!&ndash;            error => {&ndash;&gt;-->
<!--&lt;!&ndash;                document.getElementById("status").innerText = "연결 실패 ❌";&ndash;&gt;-->
<!--&lt;!&ndash;                console.error("STOMP error: ", error);&ndash;&gt;-->
<!--&lt;!&ndash;            }&ndash;&gt;-->
<!--&lt;!&ndash;        );&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->

<!--&lt;!&ndash;    function sendMessage() {&ndash;&gt;-->
<!--&lt;!&ndash;        if (!stompClient || !stompClient.connected) {&ndash;&gt;-->
<!--&lt;!&ndash;            alert("웹소켓이 아직 연결되지 않았습니다.");&ndash;&gt;-->
<!--&lt;!&ndash;            return;&ndash;&gt;-->
<!--&lt;!&ndash;        }&ndash;&gt;-->
<!--&lt;!&ndash;        const input = document.getElementById("messageInput");&ndash;&gt;-->
<!--&lt;!&ndash;        const text = input.value.trim();&ndash;&gt;-->
<!--&lt;!&ndash;        if (!text) return;&ndash;&gt;-->

<!--&lt;!&ndash;        const payload = {&ndash;&gt;-->
<!--&lt;!&ndash;            roomId: roomId,&ndash;&gt;-->
<!--&lt;!&ndash;            senderId: "testUser",   // 필요하면 이것도 userName으로 바꿔도 됨&ndash;&gt;-->
<!--&lt;!&ndash;            senderName: userName,   // ✅ 여기!&ndash;&gt;-->
<!--&lt;!&ndash;            content: text&ndash;&gt;-->
<!--&lt;!&ndash;        };&ndash;&gt;-->

<!--&lt;!&ndash;        // /pub/chat/test 로 전송&ndash;&gt;-->
<!--&lt;!&ndash;        stompClient.send(`/pub/chat/${roomId}`, {}, JSON.stringify(payload));&ndash;&gt;-->
<!--&lt;!&ndash;        log(`[송신] ${userName} : ${text}`);&ndash;&gt;-->
<!--&lt;!&ndash;        input.value = "";&ndash;&gt;-->
<!--&lt;!&ndash;    }&ndash;&gt;-->

<!--&lt;!&ndash;    // // 페이지 로드 시: 1) 이전 대화 먼저  2) 웹소켓 연결&ndash;&gt;-->
<!--&lt;!&ndash;    // window.onload = () => {&ndash;&gt;-->
<!--&lt;!&ndash;    //     // ✅ 첫 입장 시 채팅에 사용할 이름 입력 받기&ndash;&gt;-->
<!--&lt;!&ndash;    //     const inputName = prompt("채팅에 사용할 이름을 입력하세요", "나");&ndash;&gt;-->
<!--&lt;!&ndash;    //     if (inputName && inputName.trim()) {&ndash;&gt;-->
<!--&lt;!&ndash;    //         userName = inputName.trim();&ndash;&gt;-->
<!--&lt;!&ndash;    //     }&ndash;&gt;-->
<!--&lt;!&ndash;    //&ndash;&gt;-->
<!--&lt;!&ndash;    //     loadHistory();&ndash;&gt;-->
<!--&lt;!&ndash;    //     connect();&ndash;&gt;-->
<!--&lt;!&ndash;    // };&ndash;&gt;-->

<!--&lt;!&ndash;    window.onload = () => {&ndash;&gt;-->
<!--&lt;!&ndash;        const inputName = prompt("채팅에 사용할 이름", "나");&ndash;&gt;-->
<!--&lt;!&ndash;        if (inputName && inputName.trim()) userName = inputName.trim();&ndash;&gt;-->

<!--&lt;!&ndash;        const rid = prompt("방 ID를 입력하세요!", "test");&ndash;&gt;-->
<!--&lt;!&ndash;        if (rid && rid.trim()) roomId = rid.trim();&ndash;&gt;-->

<!--&lt;!&ndash;        loadHistory();   // 이 안에서 /api/chat/{roomId}/messages 사용&ndash;&gt;-->
<!--&lt;!&ndash;        connect();       // 이 안에서 /sub/chat/{roomId} 구독&ndash;&gt;-->
<!--&lt;!&ndash;    };&ndash;&gt;-->


<!--&lt;!&ndash;</script>&ndash;&gt;-->
<!--&lt;!&ndash;</body>&ndash;&gt;-->
<!--&lt;!&ndash;</html>&ndash;&gt;-->

<!--<!DOCTYPE html>-->
<!--<html lang="ko">-->
<!--<head>-->
<!--    <meta charset="UTF-8" />-->
<!--    <title>WebSocket Chat Test</title>-->

<!--    &lt;!&ndash; SockJS / STOMP &ndash;&gt;-->
<!--    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>-->
<!--    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>-->

<!--    <style>-->
<!--        body { font-family: sans-serif; display: flex; height: 100vh; margin: 0; }-->
<!--        #sidebar { width: 220px; border-right: 1px solid #ddd; padding: 10px; box-sizing: border-box; }-->
<!--        #main { flex: 1; padding: 10px; box-sizing: border-box; }-->
<!--        #roomList { list-style: none; padding-left: 0; }-->
<!--        #roomList li { padding: 5px 8px; cursor: pointer; border-radius: 4px; }-->
<!--        #roomList li.active { background: #eee; font-weight: bold; }-->
<!--        #log { list-style: none; padding-left: 0; height: 60vh; overflow-y: auto; border: 1px solid #ddd; margin-top: 8px; }-->
<!--        #log li { padding: 2px 4px; }-->
<!--        .status { margin-bottom: 8px; }-->
<!--    </style>-->
<!--</head>-->
<!--<body>-->
<!--&lt;!&ndash; 왼쪽: 방 목록 / 만들기 &ndash;&gt;-->
<!--<div id="sidebar">-->
<!--    <h3>채팅방 목록</h3>-->

<!--    <div>-->
<!--        <input id="newRoomInput" placeholder="방 ID 입력" />-->
<!--        <button onclick="createRoom()">방 생성</button>-->
<!--    </div>-->

<!--    <ul id="roomList"></ul>-->
<!--</div>-->

<!--&lt;!&ndash; 오른쪽: 채팅 영역 &ndash;&gt;-->
<!--<div id="main">-->
<!--    <h2>WebSocket Chat Test</h2>-->
<!--    <p class="status">-->
<!--        상태: <span id="status">연결 안 됨</span><br />-->
<!--        현재 방: <span id="currentRoomLabel">선택 안 됨</span><br />-->
<!--        이름: <span id="userNameLabel"></span>-->
<!--    </p>-->

<!--    <div>-->
<!--        <input id="messageInput" placeholder="메시지를 입력하세요" style="width:70%;" />-->
<!--        <button onclick="sendMessage()">전송</button>-->
<!--    </div>-->

<!--    <ul id="log"></ul>-->
<!--</div>-->

<!--<script>-->
<!--    let stompClient = null;-->
<!--    let userName = "나";-->

<!--    let rooms = [];                 // 방 ID 리스트-->
<!--    let currentRoomId = null;       // 현재 선택된 방-->
<!--    let currentSubscription = null; // 현재 STOMP 구독 객체-->

<!--    function log(text) {-->
<!--        const ul = document.getElementById("log");-->
<!--        const li = document.createElement("li");-->
<!--        li.innerText = text;-->
<!--        ul.appendChild(li);-->
<!--        ul.scrollTop = ul.scrollHeight;-->
<!--    }-->

<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45; 방 목록 UI &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->

<!--    function renderRoomList() {-->
<!--        const ul = document.getElementById("roomList");-->
<!--        ul.innerHTML = "";-->
<!--        rooms.forEach(roomId => {-->
<!--            const li = document.createElement("li");-->
<!--            li.innerText = roomId;-->
<!--            if (roomId === currentRoomId) {-->
<!--                li.classList.add("active");-->
<!--            }-->
<!--            li.onclick = () => selectRoom(roomId);-->
<!--            ul.appendChild(li);-->
<!--        });-->
<!--    }-->

<!--    // 새 방 생성 버튼-->
<!--    function createRoom() {-->
<!--        const input = document.getElementById("newRoomInput");-->
<!--        const roomId = input.value.trim();-->
<!--        if (!roomId) {-->
<!--            alert("방 ID를 입력해 주세요.");-->
<!--            return;-->
<!--        }-->
<!--        if (!rooms.includes(roomId)) {-->
<!--            rooms.push(roomId);-->
<!--            rooms.sort();-->
<!--            renderRoomList();-->
<!--        }-->
<!--        input.value = "";-->
<!--        selectRoom(roomId);-->
<!--    }-->

<!--    // 방 선택-->
<!--    function selectRoom(roomId) {-->
<!--        currentRoomId = roomId;-->
<!--        document.getElementById("currentRoomLabel").innerText = roomId;-->
<!--        document.getElementById("log").innerHTML = "";-->

<!--        renderRoomList();   // active 표시 갱신-->
<!--        loadHistory(roomId);-->
<!--        subscribeRoom(roomId);-->
<!--    }-->

<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45; 서버에서 방 목록 가져오기 &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!--    async function loadRoomListFromServer() {-->
<!--        try {-->
<!--            const res = await fetch("/api/chat/rooms");-->
<!--            const data = await res.json();     // ["A","test",...]-->
<!--            if (Array.isArray(data)) {-->
<!--                rooms = data.slice().sort();-->
<!--            } else if (data && typeof data === "object") {-->
<!--                // Set이 JSON으로 내려오면 객체일 수 있어서-->
<!--                rooms = Object.values(data).sort();-->
<!--            }-->
<!--            renderRoomList();-->
<!--        } catch (e) {-->
<!--            console.error("loadRoomList error", e);-->
<!--        }-->
<!--    }-->

<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45; 히스토리 로딩 &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
<!--    async function loadHistory(roomId) {-->
<!--        if (!roomId) return;-->
<!--        try {-->
<!--            const res = await fetch(`/api/chat/${roomId}/messages`);-->
<!--            const history = await res.json();-->
<!--            history.forEach(str => {-->
<!--                try {-->
<!--                    const msg = JSON.parse(str);-->
<!--                    log(`[이전] ${msg.senderName} : ${msg.content}`);-->
<!--                } catch (e) {-->
<!--                    console.error("parse error", e);-->
<!--                }-->
<!--            });-->
<!--        } catch (e) {-->
<!--            console.error("loadHistory error", e);-->
<!--        }-->
<!--    }-->

<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45; WebSocket 연결 & 구독 관리 &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->

<!--    function connect() {-->
<!--        const socket = new SockJS("/ws");-->
<!--        stompClient = Stomp.over(socket);-->

<!--        stompClient.connect(-->
<!--            {},-->
<!--            frame => {-->
<!--                document.getElementById("status").innerText = "연결됨 ✅";-->
<!--                console.log("STOMP connected:", frame);-->

<!--                // 만약 이미 방을 선택한 상태라면 바로 구독-->
<!--                if (currentRoomId) {-->
<!--                    subscribeRoom(currentRoomId);-->
<!--                }-->
<!--            },-->
<!--            error => {-->
<!--                document.getElementById("status").innerText = "연결 실패 ❌";-->
<!--                console.error("STOMP error:", error);-->
<!--            }-->
<!--        );-->
<!--    }-->

<!--    function subscribeRoom(roomId) {-->
<!--        if (!stompClient || !stompClient.connected || !roomId) return;-->

<!--        // 이전 구독 해제-->
<!--        if (currentSubscription) {-->
<!--            currentSubscription.unsubscribe();-->
<!--        }-->

<!--        currentSubscription = stompClient.subscribe(`/sub/chat/${roomId}`, message => {-->
<!--            try {-->
<!--                const body = JSON.parse(message.body);-->
<!--                log(`[수신] ${body.senderName} : ${body.content}`);-->
<!--            } catch (e) {-->
<!--                console.error("message parse error", e);-->
<!--            }-->
<!--        });-->

<!--        console.log("subscribed to /sub/chat/" + roomId);-->
<!--    }-->

<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45; 메시지 전송 &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->

<!--    function sendMessage() {-->
<!--        if (!stompClient || !stompClient.connected) {-->
<!--            alert("웹소켓이 아직 연결되지 않았습니다.");-->
<!--            return;-->
<!--        }-->
<!--        if (!currentRoomId) {-->
<!--            alert("먼저 채팅방을 선택하거나 생성해 주세요.");-->
<!--            return;-->
<!--        }-->

<!--        const input = document.getElementById("messageInput");-->
<!--        const text = input.value.trim();-->
<!--        if (!text) return;-->

<!--        const payload = {-->
<!--            roomId: currentRoomId,-->
<!--            senderId: "testUser",-->
<!--            senderName: userName,-->
<!--            content: text-->
<!--        };-->

<!--        stompClient.send(`/pub/chat/${currentRoomId}`, {}, JSON.stringify(payload));-->
<!--        log(`[송신] ${userName} : ${text}`);-->
<!--        input.value = "";-->
<!--    }-->

<!--    // &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45; 초기 로드 &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->

<!--    window.onload = async () => {-->
<!--        const name = prompt("채팅에 사용할 이름을 입력하세요", "나");-->
<!--        if (name && name.trim()) {-->
<!--            userName = name.trim();-->
<!--        }-->
<!--        document.getElementById("userNameLabel").innerText = userName;-->

<!--        await loadRoomListFromServer();  // 기존에 Redis에 있던 방들 목록-->
<!--        connect();-->
<!--    };-->
<!--</script>-->
<!--</body>-->
<!--</html>-->

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>WebSocket Chat Test</title>

    <!-- SockJS / STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        body { font-family: sans-serif; display: flex; height: 100vh; margin: 0; }
        #sidebar { width: 260px; border-right: 1px solid #ddd; padding: 10px; box-sizing: border-box; }
        #main { flex: 1; padding: 10px; box-sizing: border-box; }
        #roomList { list-style: none; padding-left: 0; }
        #roomList li { padding: 5px 8px; cursor: pointer; border-radius: 4px; }
        #roomList li.active { background: #eee; font-weight: bold; }
        #log { list-style: none; padding-left: 0; height: 60vh; overflow-y: auto; border: 1px solid #ddd; margin-top: 8px; }
        #log li { padding: 2px 4px; }
        .status { margin-bottom: 8px; }
        .field { margin-top: 4px; font-size: 12px; }
        .field label { display: block; }
        input[type="time"], input[type="number"], input[type="text"] { width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>
<!-- 왼쪽: 방 목록 / 만들기 -->
<div id="sidebar">
    <h3>채팅방 생성</h3>

    <div class="field">
        <label>방 ID</label>
        <input id="newRoomInput" placeholder="예: A, test" />
    </div>

    <div class="field">
        <label>기간 시작일</label>
        <input id="periodStartInput" type="date" />
    </div>

    <div class="field">
        <label>기간 종료일</label>
        <input id="periodEndInput" type="date" />
    </div>


    <div class="field">
        <label>시작 시간</label>
        <input id="startTimeInput" type="time" value="07:00" />
    </div>

    <div class="field">
        <label>끝 시간</label>
        <input id="endTimeInput" type="time" value="21:00" />
    </div>

    <div class="field">
        <label>하루에 몇 번 받을지</label>
        <input id="countInput" type="number" min="1" max="10" value="3" />
    </div>

    <div class="field">
        <label>최소 간격(시간)</label>
        <input id="intervalInput" type="number" min="1" max="12" value="3" />
    </div>

    <button style="margin-top:8px;" onclick="createRoom()">방 생성 + 스케줄 등록</button>

    <hr />

    <h3>채팅방 목록</h3>
    <ul id="roomList"></ul>
</div>

<!-- 오른쪽: 채팅 영역 -->
<div id="main">
    <h2>WebSocket Chat Test</h2>
    <p class="status">
        상태: <span id="status">연결 안 됨</span><br />
        현재 방: <span id="currentRoomLabel">선택 안 됨</span><br />
        이름: <span id="userNameLabel"></span>
    </p>

    <div>
        <input id="messageInput" placeholder="메시지를 입력하세요" style="width:70%;" />
        <button onclick="sendMessage()">전송</button>
    </div>

    <ul id="log"></ul>
</div>

<script>
    // API 베이스 (같은 서버에서 띄우면 빈 문자열이면 됨)
    const API_BASE_URL = "";

    let stompClient = null;
    let userName = "나";

    let rooms = [];                 // 방 ID 리스트
    let currentRoomId = null;       // 현재 선택된 방
    let currentSubscription = null; // 현재 STOMP 구독 객체

    function log(text) {
        const ul = document.getElementById("log");
        const li = document.createElement("li");
        li.innerText = text;
        ul.appendChild(li);
        ul.scrollTop = ul.scrollHeight;
    }

    // ---------- 방 목록 UI ----------

    function renderRoomList() {
        const ul = document.getElementById("roomList");
        ul.innerHTML = "";
        rooms.forEach(roomId => {
            const li = document.createElement("li");
            li.innerText = roomId;
            if (roomId === currentRoomId) {
                li.classList.add("active");
            }
            li.onclick = () => selectRoom(roomId);
            ul.appendChild(li);
        });
    }

    // 새 방 생성 + 스케줄 등록
    async function createRoom() {
        const input = document.getElementById("newRoomInput");
        const roomId = input.value.trim();
        if (!roomId) {
            alert("방 ID를 입력해 주세요.");
            return;
        }

        // 스케줄 정보 읽어서 서버에 등록
        try {
            await scheduleRoom(roomId);
        } catch (e) {
            console.error("scheduleRoom error", e);
            alert("스케줄 등록 중 오류가 발생했습니다.");
            return;
        }

        // 방 목록에 추가
        if (!rooms.includes(roomId)) {
            rooms.push(roomId);
            rooms.sort();
            renderRoomList();
        }
        input.value = "";
        selectRoom(roomId);
    }

    // 스케줄 등록 API 호출
    async function scheduleRoom(roomId) {
        const startTime = document.getElementById("startTimeInput").value || "07:00";
        const endTime = document.getElementById("endTimeInput").value || "21:00";
        const countPerDay = parseInt(document.getElementById("countInput").value || "3", 10);
        const minIntervalHours = parseInt(document.getElementById("intervalInput").value || "3", 10);

        const periodStartDate = document.getElementById("periodStartInput").value; // "2025-12-01"
        const periodEndDate = document.getElementById("periodEndInput").value;     // "2025-12-14"

        const resp = await fetch(`${API_BASE_URL}/api/chat/schedule`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                roomId: roomId,
                startTime: startTime,
                endTime: endTime,
                countPerDay: countPerDay,
                minIntervalHours: minIntervalHours,
                periodStartDate: periodStartDate,
                periodEndDate: periodEndDate,
            }),
        });

        const text = await resp.text();
        if (text === "time_range_too_short") {
            throw new Error("시간 범위가 최소 간격과 횟수 조건을 만족하지 않습니다.");
        }
        if (!resp.ok) {
            throw new Error("HTTP error " + resp.status);
        }
        console.log("schedule set:", roomId, text);
    }


    // 방 선택
    function selectRoom(roomId) {
        currentRoomId = roomId;
        document.getElementById("currentRoomLabel").innerText = roomId;
        document.getElementById("log").innerHTML = "";

        renderRoomList();   // active 표시 갱신
        loadHistory(roomId);
        subscribeRoom(roomId);
    }

    // ---------- 서버에서 방 목록 가져오기 ----------
    async function loadRoomListFromServer() {
        try {
            const res = await fetch("/api/chat/rooms");
            const data = await res.json();     // ["A","test",...] or Object
            if (Array.isArray(data)) {
                rooms = data.slice().sort();
            } else if (data && typeof data === "object") {
                rooms = Object.values(data).sort();
            }
            renderRoomList();
        } catch (e) {
            console.error("loadRoomList error", e);
        }
    }

    // ---------- 히스토리 로딩 ----------
    async function loadHistory(roomId) {
        if (!roomId) return;
        try {
            const res = await fetch(`/api/chat/${roomId}/messages`);
            const history = await res.json();
            history.forEach(str => {
                try {
                    const msg = JSON.parse(str);
                    log(`[이전] ${msg.senderName} : ${msg.content}`);
                } catch (e) {
                    console.error("parse error", e);
                }
            });
        } catch (e) {
            console.error("loadHistory error", e);
        }
    }

    // ---------- WebSocket 연결 & 구독 관리 ----------

    function connect() {
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect(
            {},
            frame => {
                document.getElementById("status").innerText = "연결됨 ✅";
                console.log("STOMP connected:", frame);

                // 이미 방을 선택한 상태라면 바로 구독
                if (currentRoomId) {
                    subscribeRoom(currentRoomId);
                }
            },
            error => {
                document.getElementById("status").innerText = "연결 실패 ❌";
                console.error("STOMP error:", error);
            }
        );
    }

    function subscribeRoom(roomId) {
        if (!stompClient || !stompClient.connected || !roomId) return;

        // 이전 구독 해제
        if (currentSubscription) {
            currentSubscription.unsubscribe();
        }

        currentSubscription = stompClient.subscribe(`/sub/chat/${roomId}`, message => {
            try {
                const body = JSON.parse(message.body);
                log(`[수신] ${body.senderName} : ${body.content}`);
            } catch (e) {
                console.error("message parse error", e);
            }
        });

        console.log("subscribed to /sub/chat/" + roomId);
    }

    // ---------- 메시지 전송 ----------

    function sendMessage() {
        if (!stompClient || !stompClient.connected) {
            alert("웹소켓이 아직 연결되지 않았습니다.");
            return;
        }
        if (!currentRoomId) {
            alert("먼저 채팅방을 선택하거나 생성해 주세요.");
            return;
        }

        const input = document.getElementById("messageInput");
        const text = input.value.trim();
        if (!text) return;

        const payload = {
            roomId: currentRoomId,
            senderId: "testUser",
            senderName: userName,
            content: text
        };

        stompClient.send(`/pub/chat/${currentRoomId}`, {}, JSON.stringify(payload));
        log(`[송신] ${userName} : ${text}`);
        input.value = "";
    }

    // ---------- 초기 로드 ----------

    window.onload = async () => {
        const name = prompt("채팅에 사용할 이름을 입력하세요", "나");
        if (name && name.trim()) {
            userName = name.trim();
        }
        document.getElementById("userNameLabel").innerText = userName;

        await loadRoomListFromServer();  // 기존에 Redis에 있던 방들 목록
        connect();
    };
</script>
</body>
</html>
